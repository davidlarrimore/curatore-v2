version: "3.9"

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: curatore-backend
    volumes:
      - ./backend:/app
      # FIXED: Map root-level files directory to /app/files inside container
      - ./files:/app/files
    ports:
      - "8000:8000"
    environment:
      - PYTHONUNBUFFERED=1
      # Load from .env file
      - DEBUG=${DEBUG:-false}
      - CORS_ORIGINS=${CORS_ORIGINS:-["http://localhost:3000"]}
      # OpenAI/LLM Configuration
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.openai.com/v1}
      - OPENAI_VERIFY_SSL=${OPENAI_VERIFY_SSL:-true}
      - OPENAI_TIMEOUT=${OPENAI_TIMEOUT:-60}
      - OPENAI_MAX_RETRIES=${OPENAI_MAX_RETRIES:-3}
      # OCR Configuration
      - OCR_LANG=${OCR_LANG:-eng}
      - OCR_PSM=${OCR_PSM:-3}
      # File Storage - FIXED: Use absolute paths inside container
      - FILES_ROOT=/app/files
      - UPLOAD_DIR=/app/files/uploaded_files
      - PROCESSED_DIR=/app/files/processed_files
      - BATCH_DIR=/app/files/batch_files
      - MAX_FILE_SIZE=${MAX_FILE_SIZE:-52428800}
      # Quality Thresholds
      - DEFAULT_CONVERSION_THRESHOLD=${DEFAULT_CONVERSION_THRESHOLD:-70}
      - DEFAULT_CLARITY_THRESHOLD=${DEFAULT_CLARITY_THRESHOLD:-7}
      - DEFAULT_COMPLETENESS_THRESHOLD=${DEFAULT_COMPLETENESS_THRESHOLD:-7}
      - DEFAULT_RELEVANCE_THRESHOLD=${DEFAULT_RELEVANCE_THRESHOLD:-7}
      - DEFAULT_MARKDOWN_THRESHOLD=${DEFAULT_MARKDOWN_THRESHOLD:-7}
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: curatore-frontend
    volumes:
      - ./frontend:/app
      - /app/node_modules
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000
    command: npm run dev
    depends_on:
      - backend