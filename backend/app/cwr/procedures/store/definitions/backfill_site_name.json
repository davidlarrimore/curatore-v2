{
  "name": "Backfill SharePoint Site Name",
  "slug": "backfill_site_name",
  "description": "Discover all SharePoint sync configs, resolve each site's display name via Microsoft Graph API, then propagate site_name to all linked assets' source_metadata.sharepoint and the search index. No parameters required â€” processes all active configs automatically.",
  "version": "2.0.0",
  "is_system": true,
  "tags": ["sharepoint", "backfill", "metadata", "maintenance"],
  "parameters": [],
  "steps": [
    {
      "name": "discover_configs",
      "function": "discover_data_sources",
      "description": "Find all active SharePoint sync configurations",
      "params": {
        "source_type": "sharepoint"
      },
      "on_error": "fail",
      "condition": null,
      "foreach": null
    },
    {
      "name": "process_configs",
      "function": "foreach",
      "description": "For each SharePoint sync config: resolve site name, find linked assets, and update their metadata",
      "params": {
        "items": "{{ steps.discover_configs.source_types[0].instances }}",
        "concurrency": 1
      },
      "on_error": "continue",
      "condition": null,
      "foreach": null,
      "branches": {
        "each": [
          {
            "name": "get_site",
            "function": "sp_get_site",
            "description": "Resolve site display name from Microsoft Graph API",
            "params": {
              "sync_config_id": "{{ item.id }}"
            },
            "on_error": "fail",
            "condition": null,
            "foreach": null
          },
          {
            "name": "find_assets",
            "function": "search_assets",
            "description": "Find assets linked to this sync config that are missing site_name",
            "params": {
              "query": "*",
              "source_type": "sharepoint",
              "sync_config_id": "{{ item.id }}",
              "where": [{"field": "sharepoint.site_name", "op": "is_empty"}],
              "limit": 1000
            },
            "on_error": "fail",
            "condition": null,
            "foreach": null
          },
          {
            "name": "update_assets",
            "function": "update_source_metadata",
            "description": "Set site_name in source_metadata.sharepoint for each asset",
            "params": {
              "asset_id": "{{ item.id }}",
              "namespace": "sharepoint",
              "fields": {
                "site_name": "{{ steps.get_site.fields.display_name }}"
              },
              "propagate_to_search": true
            },
            "on_error": "continue",
            "condition": null,
            "foreach": "{{ steps.find_assets }}"
          }
        ]
      }
    }
  ],
  "outputs": [
    {
      "type": "result",
      "config": {
        "include_steps": ["discover_configs", "process_configs"]
      }
    }
  ],
  "triggers": [],
  "on_error": "continue"
}
