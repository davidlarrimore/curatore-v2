'use client'

import React, { useState, useEffect } from 'react'
import { useAuth } from '@/lib/auth-context'
import { objectStorageApi, utils } from '@/lib/api'
import ProtectedRoute from '@/components/auth/ProtectedRoute'
import FilePreview from '@/components/storage/FilePreview'
import StorageFolderBrowser from '@/components/storage/StorageFolderBrowser'
import {
  Database,
  HardDrive,
  CheckCircle,
  XCircle,
  AlertCircle,
  Loader2,
  Download,
  Trash2,
  RefreshCw,
  FolderOpen,
  File,
  FileText,
  Upload,
  Edit3,
  X,
  Eye,
  ArrowUpDown,
  ArrowUp,
  ArrowDown,
  Search,
  List,
  Grid,
} from 'lucide-react'

export default function StoragePage() {
  return (
    <ProtectedRoute requiredRole="org_admin">
      <StorageContent />
    </ProtectedRoute>
  )
}

function formatBytes(bytes: number | null): string {
  if (bytes === null || bytes === 0) return '0 Bytes'
  const k = 1024
  const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB']
  const i = Math.floor(Math.log(bytes) / Math.log(k))
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i]
}

function formatDate(dateString: string | null): string {
  if (!dateString) return 'N/A'
  const date = new Date(dateString)
  return date.toLocaleString()
}

interface Artifact {
  id: string
  document_id: string
  artifact_type: string
  bucket: string
  object_key: string
  original_filename: string
  content_type: string | null
  file_size: number | null
  status: string
  created_at: string
}

function StorageContent() {
  const { token } = useAuth()
  const [healthData, setHealthData] = useState<any>(null)
  const [selectedBucket, setSelectedBucket] = useState<string | null>(null)
  const [artifacts, setArtifacts] = useState<Artifact[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const [isLoadingArtifacts, setIsLoadingArtifacts] = useState(false)
  const [error, setError] = useState('')
  const [successMessage, setSuccessMessage] = useState('')
  const [downloadingId, setDownloadingId] = useState<string | null>(null)
  const [isUploading, setIsUploading] = useState(false)
  const [dragActive, setDragActive] = useState(false)
  const [editingArtifactId, setEditingArtifactId] = useState<string | null>(null)
  const [newFilename, setNewFilename] = useState('')
  const [selectedArtifacts, setSelectedArtifacts] = useState<Set<string>>(new Set())
  const [isDeletingBulk, setIsDeletingBulk] = useState(false)
  const [previewArtifact, setPreviewArtifact] = useState<Artifact | null>(null)
  const [previewBlob, setPreviewBlob] = useState<Blob | null>(null)
  const [isLoadingPreview, setIsLoadingPreview] = useState(false)
  const [previewError, setPreviewError] = useState<string | null>(null)
  const [sortColumn, setSortColumn] = useState<'filename' | 'type' | 'size' | 'status' | 'created'>('created')
  const [sortDirection, setSortDirection] = useState<'asc' | 'desc'>('desc')
  const [searchQuery, setSearchQuery] = useState('')
  const fileInputRef = React.useRef<HTMLInputElement>(null)
  const [uploadTargetBucket, setUploadTargetBucket] = useState<string | null>(null)
  const [uploadTargetPrefix, setUploadTargetPrefix] = useState<string>('')
  const [showUploadModal, setShowUploadModal] = useState(false)

  useEffect(() => {
    if (token) {
      loadHealthData()
    }
  }, [token])

  const loadHealthData = async () => {
    if (!token) return

    setIsLoading(true)
    setError('')

    try {
      const health = await objectStorageApi.getHealth()
      setHealthData(health)
    } catch (err: any) {
      setError(err.message || 'Failed to load storage health')
    } finally {
      setIsLoading(false)
    }
  }

  const loadArtifactsForBucket = async (bucket: string) => {
    if (!token) return

    setIsLoadingArtifacts(true)
    setSelectedBucket(bucket)
    setError('')
    setSuccessMessage('')
    setArtifacts([])
    setSelectedArtifacts(new Set()) // Clear selection when switching buckets

    try {
      // Load all artifacts and filter by bucket
      const allArtifacts = await objectStorageApi.listArtifacts(undefined, 1000, 0, token)
      const bucketArtifacts = allArtifacts.filter(a => a.bucket === bucket)
      setArtifacts(bucketArtifacts)
    } catch (err: any) {
      console.error('Failed to load artifacts:', err)
      setError(err.message || 'Failed to load artifacts')
    } finally {
      setIsLoadingArtifacts(false)
    }
  }

  const handleDownloadArtifact = async (artifact: Artifact) => {
    if (!token) return

    setDownloadingId(artifact.id)
    setError('')
    setSuccessMessage('')
    try {
      // Use presigned URL for download
      const blob = await objectStorageApi.downloadFile(artifact.document_id, artifact.artifact_type as any)
      utils.downloadBlob(blob, artifact.original_filename)
      setSuccessMessage(`Downloaded ${artifact.original_filename}`)
    } catch (err: any) {
      console.error('Download failed:', err)
      setError(`Failed to download: ${err.message}`)
    } finally {
      setDownloadingId(null)
    }
  }

  const handleDeleteArtifact = async (artifact: Artifact) => {
    if (!token) return

    const confirmed = window.confirm(`Delete ${artifact.original_filename}? This cannot be undone.`)
    if (!confirmed) return

    setError('')
    setSuccessMessage('')
    try {
      await objectStorageApi.deleteArtifact(artifact.id, token)
      setSuccessMessage(`Deleted ${artifact.original_filename}`)
      // Reload artifacts for the current bucket
      if (selectedBucket) {
        await loadArtifactsForBucket(selectedBucket)
      }
    } catch (err: any) {
      console.error('Delete failed:', err)
      setError(`Failed to delete: ${err.message}`)
    }
  }

  const handleFileUpload = async (files: FileList | File[]) => {
    if (!token || !uploadTargetBucket) return

    setIsUploading(true)
    setError('')
    setSuccessMessage('')

    const fileArray = Array.from(files)
    let successCount = 0
    let failCount = 0

    try {
      // Upload files sequentially to avoid overwhelming the system
      for (const file of fileArray) {
        try {
          // Use folder upload API with target bucket and prefix
          await objectStorageApi.uploadToFolder(uploadTargetBucket, uploadTargetPrefix, file, token)
          successCount++
        } catch (err: any) {
          console.error(`Failed to upload ${file.name}:`, err)
          failCount++
        }
      }

      // Show results
      if (successCount > 0 && failCount === 0) {
        setSuccessMessage(`Successfully uploaded ${successCount} file(s) to ${uploadTargetBucket}/${uploadTargetPrefix || 'root'}`)
      } else if (successCount > 0 && failCount > 0) {
        setSuccessMessage(`Uploaded ${successCount} file(s), ${failCount} failed`)
      } else if (failCount > 0) {
        setError(`Failed to upload ${failCount} file(s)`)
      }

      // Reload artifacts
      if (selectedBucket) {
        await loadArtifactsForBucket(selectedBucket)
      }

      // Close modal
      setShowUploadModal(false)

      // Refresh folder view (trigger event or reload)
      window.location.reload()
    } finally {
      setIsUploading(false)
    }
  }

  const handleOpenUpload = (bucket: string, prefix: string) => {
    setUploadTargetBucket(bucket)
    setUploadTargetPrefix(prefix)
    setShowUploadModal(true)
  }

  const handleDragOver = (e: React.DragEvent) => {
    e.preventDefault()
    e.stopPropagation()
    setDragActive(true)
  }

  const handleDragLeave = (e: React.DragEvent) => {
    e.preventDefault()
    e.stopPropagation()
    setDragActive(false)
  }

  const handleDrop = (e: React.DragEvent) => {
    e.preventDefault()
    e.stopPropagation()
    setDragActive(false)

    const files = e.dataTransfer.files
    if (files && files.length > 0) {
      handleFileUpload(files)
    }
  }

  const handleFileInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files
    if (files && files.length > 0) {
      handleFileUpload(files)
    }
    // Reset input value to allow re-selecting the same file
    e.target.value = ''
  }

  const handleToggleArtifact = (artifactId: string) => {
    setSelectedArtifacts(prev => {
      const newSet = new Set(prev)
      if (newSet.has(artifactId)) {
        newSet.delete(artifactId)
      } else {
        newSet.add(artifactId)
      }
      return newSet
    })
  }

  const handleSelectAll = () => {
    if (selectedArtifacts.size === artifacts.length) {
      setSelectedArtifacts(new Set())
    } else {
      setSelectedArtifacts(new Set(artifacts.map(a => a.id)))
    }
  }

  const handleBulkDelete = async () => {
    if (!token || selectedArtifacts.size === 0) return

    const confirmed = window.confirm(
      `Delete ${selectedArtifacts.size} file(s)? This cannot be undone.`
    )
    if (!confirmed) return

    setIsDeletingBulk(true)
    setError('')
    setSuccessMessage('')

    let successCount = 0
    let failCount = 0

    try {
      // Delete artifacts sequentially
      for (const artifactId of selectedArtifacts) {
        try {
          await objectStorageApi.deleteArtifact(artifactId, token)
          successCount++
        } catch (err: any) {
          console.error(`Failed to delete artifact ${artifactId}:`, err)
          failCount++
        }
      }

      // Show results
      if (successCount > 0 && failCount === 0) {
        setSuccessMessage(`Successfully deleted ${successCount} file(s)`)
      } else if (successCount > 0 && failCount > 0) {
        setSuccessMessage(`Deleted ${successCount} file(s), ${failCount} failed`)
      } else if (failCount > 0) {
        setError(`Failed to delete ${failCount} file(s)`)
      }

      // Clear selection and reload
      setSelectedArtifacts(new Set())
      if (selectedBucket) {
        await loadArtifactsForBucket(selectedBucket)
      }
    } finally {
      setIsDeletingBulk(false)
    }
  }

  const handlePreviewArtifact = async (artifact: Artifact) => {
    if (!token) return

    setPreviewArtifact(artifact)
    setIsLoadingPreview(true)
    setPreviewBlob(null)
    setPreviewError(null)

    try {
      const blob = await objectStorageApi.downloadFile(artifact.document_id, artifact.artifact_type as any)
      setPreviewBlob(blob)
    } catch (err: any) {
      console.error('Preview failed:', err)
      setPreviewError(err.message || 'Failed to load preview')
    } finally {
      setIsLoadingPreview(false)
    }
  }

  const handleClosePreview = () => {
    setPreviewArtifact(null)
    setPreviewBlob(null)
    setPreviewError(null)
  }

  const handleRefresh = () => {
    loadHealthData()
    if (selectedBucket) {
      loadArtifactsForBucket(selectedBucket)
    }
  }

  const handleSort = (column: 'filename' | 'type' | 'size' | 'status' | 'created') => {
    if (sortColumn === column) {
      setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc')
    } else {
      setSortColumn(column)
      setSortDirection('asc')
    }
  }

  // Filter and sort artifacts
  const filteredAndSortedArtifacts = React.useMemo(() => {
    let filtered = artifacts

    // Apply search filter
    if (searchQuery.trim()) {
      const query = searchQuery.toLowerCase()
      filtered = filtered.filter(artifact =>
        artifact.original_filename.toLowerCase().includes(query) ||
        artifact.artifact_type.toLowerCase().includes(query) ||
        artifact.status.toLowerCase().includes(query)
      )
    }

    // Apply sorting
    const sorted = [...filtered].sort((a, b) => {
      let comparison = 0

      switch (sortColumn) {
        case 'filename':
          comparison = a.original_filename.localeCompare(b.original_filename)
          break
        case 'type':
          comparison = a.artifact_type.localeCompare(b.artifact_type)
          break
        case 'size':
          comparison = (a.file_size || 0) - (b.file_size || 0)
          break
        case 'status':
          comparison = a.status.localeCompare(b.status)
          break
        case 'created':
          comparison = new Date(a.created_at).getTime() - new Date(b.created_at).getTime()
          break
      }

      return sortDirection === 'asc' ? comparison : -comparison
    })

    return sorted
  }, [artifacts, searchQuery, sortColumn, sortDirection])

  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-gray-50 via-white to-gray-50 dark:from-gray-950 dark:via-gray-900 dark:to-gray-950">
        <div className="text-center">
          <Loader2 className="h-12 w-12 text-indigo-600 dark:text-indigo-400 animate-spin mx-auto" />
          <p className="mt-4 text-gray-600 dark:text-gray-400">Loading storage data...</p>
        </div>
      </div>
    )
  }

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'healthy':
        return 'from-emerald-500 to-teal-600'
      case 'unhealthy':
        return 'from-red-500 to-rose-600'
      case 'disabled':
        return 'from-gray-400 to-gray-500'
      default:
        return 'from-gray-400 to-gray-500'
    }
  }

  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'healthy':
        return <CheckCircle className="h-5 h-5 text-emerald-600 dark:text-emerald-400" />
      case 'unhealthy':
        return <XCircle className="h-5 h-5 text-red-600 dark:text-red-400" />
      case 'disabled':
        return <AlertCircle className="h-5 h-5 text-gray-600 dark:text-gray-400" />
      default:
        return <AlertCircle className="h-5 h-5 text-gray-600 dark:text-gray-400" />
    }
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 via-white to-gray-50 dark:from-gray-950 dark:via-gray-900 dark:to-gray-950">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        {/* Header */}
        <div className="flex items-center justify-between mb-8">
          <div className="flex items-center gap-4">
            <div className="flex items-center justify-center w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 text-white shadow-lg shadow-indigo-500/25">
              <Database className="w-6 h-6" />
            </div>
            <div>
              <h1 className="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white">
                Object Storage
              </h1>
              <p className="text-sm text-gray-500 dark:text-gray-400 mt-0.5">
                S3-compatible object storage management (MinIO/AWS S3)
              </p>
            </div>
          </div>

          <button
            onClick={handleRefresh}
            className="flex items-center gap-2 px-4 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors shadow-sm"
          >
            <RefreshCw className="w-4 h-4" />
            <span className="text-sm font-medium hidden sm:inline">Refresh</span>
          </button>
        </div>

        {/* Success Banner */}
        {successMessage && (
          <div className="mb-6 rounded-xl bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-100 dark:border-emerald-900/50 p-4">
            <div className="flex items-center justify-between gap-3">
              <div className="flex items-center gap-3">
                <div className="flex-shrink-0 w-10 h-10 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center">
                  <CheckCircle className="w-5 h-5 text-emerald-600 dark:text-emerald-400" />
                </div>
                <p className="text-sm font-medium text-emerald-800 dark:text-emerald-200">{successMessage}</p>
              </div>
              <button
                onClick={() => setSuccessMessage('')}
                className="text-emerald-600 dark:text-emerald-400 hover:text-emerald-700 dark:hover:text-emerald-300"
              >
                <X className="w-5 h-5" />
              </button>
            </div>
          </div>
        )}

        {/* Error Banner */}
        {error && (
          <div className="mb-6 rounded-xl bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-900/50 p-4">
            <div className="flex items-center justify-between gap-3">
              <div className="flex items-center gap-3">
                <div className="flex-shrink-0 w-10 h-10 rounded-lg bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
                  <AlertCircle className="w-5 h-5 text-red-600 dark:text-red-400" />
                </div>
                <p className="text-sm font-medium text-red-800 dark:text-red-200">{error}</p>
              </div>
              <button
                onClick={() => setError('')}
                className="text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300"
              >
                <X className="w-5 h-5" />
              </button>
            </div>
          </div>
        )}

        {/* Storage Not Enabled Message */}
        {healthData && !healthData.enabled && (
          <div className="relative overflow-hidden rounded-2xl border-2 border-dashed border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800/50 px-6 py-16 text-center">
            <div className="absolute inset-0 pointer-events-none">
              <div className="absolute -top-24 -right-24 w-64 h-64 rounded-full bg-gradient-to-br from-indigo-500/5 to-purple-500/5 blur-3xl"></div>
            </div>
            <div className="relative">
              <div className="mx-auto w-20 h-20 rounded-2xl bg-gradient-to-br from-gray-400 to-gray-500 flex items-center justify-center shadow-xl shadow-gray-500/25 mb-6">
                <Database className="w-10 h-10 text-white" />
              </div>
              <h3 className="text-xl font-semibold text-gray-900 dark:text-white mb-2">
                Object Storage Not Enabled
              </h3>
              <p className="text-gray-500 dark:text-gray-400 max-w-md mx-auto mb-4">
                Object storage is currently disabled. Enable it in your configuration to use S3-compatible storage.
              </p>
              <p className="text-sm text-gray-400 dark:text-gray-500">
                Set <code className="px-2 py-0.5 bg-gray-100 dark:bg-gray-800 rounded">USE_OBJECT_STORAGE=true</code> in your environment
              </p>
            </div>
          </div>
        )}

        {/* Storage Enabled Content */}
        {healthData && healthData.enabled && (
          <>
            {/* Folder Browser View */}
            <div className="mb-8">
              <StorageFolderBrowser
                onFileUpload={handleOpenUpload}
                onFilePreview={async (bucket, key, filename) => {
                    // Extract document ID from key (format: org_id/document_id/uploaded/filename)
                    const parts = key.split('/')
                    if (parts.length >= 2) {
                      const documentId = parts[1]
                      // Load artifact and preview
                      try {
                        const artifacts = await objectStorageApi.listDocumentArtifacts(documentId, token ?? undefined)
                        const artifact = artifacts.find(a => a.bucket === bucket && a.object_key === key)
                        if (artifact) {
                          setPreviewArtifact({
                            id: artifact.id,
                            document_id: artifact.document_id,
                            artifact_type: artifact.artifact_type,
                            bucket: artifact.bucket,
                            object_key: artifact.object_key,
                            original_filename: artifact.original_filename,
                            content_type: artifact.content_type,
                            file_size: artifact.file_size,
                            status: artifact.status,
                            created_at: artifact.created_at,
                          })
                          setIsLoadingPreview(true)
                          setPreviewBlob(null)
                          setPreviewError(null)

                          try {
                            const blob = await objectStorageApi.downloadFile(documentId, artifact.artifact_type as any)
                            setPreviewBlob(blob)
                          } catch (err: any) {
                            console.error('Preview failed:', err)
                            setPreviewError(err.message || 'Failed to load preview')
                          } finally {
                            setIsLoadingPreview(false)
                          }
                        }
                      } catch (err) {
                        console.error('Failed to load artifact for preview:', err)
                      }
                    }
                  }}
                  onFileDownload={async (bucket, key, filename) => {
                    // Extract document ID from key
                    const parts = key.split('/')
                    if (parts.length >= 2) {
                      const documentId = parts[1]
                      try {
                        const artifacts = await objectStorageApi.listDocumentArtifacts(documentId, token ?? undefined)
                        const artifact = artifacts.find(a => a.bucket === bucket && a.object_key === key)
                        if (artifact) {
                          const blob = await objectStorageApi.downloadFile(documentId, artifact.artifact_type as any)
                          utils.downloadBlob(blob, filename)
                        }
                      } catch (err: any) {
                        console.error('Download failed:', err)
                        setError(`Failed to download: ${err.message}`)
                      }
                    }
                  }}
                />
            </div>
          </>
        )}

      {/* Preview Modal */}
      {previewArtifact && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
          <div className="relative bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] flex flex-col overflow-hidden">
            {/* Modal Header */}
            <div className="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-600">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center">
                  <Eye className="w-5 h-5 text-white" />
                </div>
                <div>
                  <h3 className="text-lg font-semibold text-white">
                    {previewArtifact.original_filename}
                  </h3>
                  <p className="text-xs text-indigo-100 mt-0.5">
                    {formatBytes(previewArtifact.file_size || 0)} • {previewArtifact.artifact_type}
                  </p>
                </div>
              </div>
              <button
                onClick={handleClosePreview}
                className="text-white hover:bg-white/20 rounded-lg p-2 transition-colors"
              >
                <X className="w-5 h-5" />
              </button>
            </div>

            {/* Modal Content */}
            <div className="flex-1 overflow-auto p-6">
              {isLoadingPreview ? (
                <div className="flex flex-col items-center justify-center py-12">
                  <Loader2 className="h-12 w-12 text-indigo-600 dark:text-indigo-400 animate-spin mb-4" />
                  <p className="text-sm text-gray-500 dark:text-gray-400">Loading preview...</p>
                </div>
              ) : previewError ? (
                <div className="flex flex-col items-center justify-center py-12">
                  <div className="w-16 h-16 rounded-2xl bg-red-100 dark:bg-red-900/30 flex items-center justify-center mb-4">
                    <AlertCircle className="w-8 h-8 text-red-600 dark:text-red-400" />
                  </div>
                  <p className="text-sm font-medium text-red-800 dark:text-red-200 mb-2">Preview Failed</p>
                  <p className="text-sm text-gray-600 dark:text-gray-400">{previewError}</p>
                </div>
              ) : previewBlob ? (
                <FilePreview
                  blob={previewBlob}
                  filename={previewArtifact.original_filename}
                  contentType={previewArtifact.content_type}
                />
              ) : null}
            </div>

            {/* Modal Footer */}
            <div className="flex items-center justify-between px-6 py-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
              <div className="text-xs text-gray-500 dark:text-gray-400">
                Created: {formatDate(previewArtifact.created_at)}
              </div>
              <div className="flex gap-2">
                <button
                  onClick={() => {
                    handleDownloadArtifact(previewArtifact)
                  }}
                  className="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg transition-colors"
                >
                  <Download className="w-4 h-4" />
                  Download
                </button>
                <button
                  onClick={handleClosePreview}
                  className="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg transition-colors"
                >
                  Close
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Upload Modal */}
      {showUploadModal && uploadTargetBucket && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
          <div className="relative bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden">
            {/* Modal Header */}
            <div className="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-emerald-600 via-teal-600 to-emerald-600">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center">
                  <Upload className="w-5 h-5 text-white" />
                  </div>
                  <div className="flex-1">
                    <div className="flex items-center gap-3">
                      <h2 className="text-lg font-semibold text-gray-900 dark:text-white">
                        Storage Buckets
                      </h2>
                      <span className="px-2 py-0.5 text-xs font-medium rounded-full bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400">
                        {healthData.buckets.length}
                      </span>
                    </div>
                    <p className="text-sm text-gray-500 dark:text-gray-400 mt-0.5">
                      Available S3-compatible storage buckets
                    </p>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  {healthData.buckets.map((bucket: string) => (
                    <button
                      key={bucket}
                      onClick={() => loadArtifactsForBucket(bucket)}
                      className={`relative bg-white dark:bg-gray-800 rounded-xl border-2 transition-all duration-200 overflow-hidden text-left p-5 ${
                        selectedBucket === bucket
                          ? 'border-indigo-500 shadow-lg shadow-indigo-500/20'
                          : 'border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600 hover:shadow-lg hover:shadow-gray-200/50 dark:hover:shadow-gray-900/50'
                      }`}
                    >
                      <div className={`absolute top-0 left-0 right-0 h-1 ${
                        selectedBucket === bucket
                          ? 'bg-gradient-to-r from-indigo-500 to-purple-600'
                          : 'bg-gradient-to-r from-blue-500 to-cyan-600'
                      }`} />

                      <div className="flex items-center gap-3 mb-3">
                        <div className={`w-10 h-10 rounded-lg ${
                          selectedBucket === bucket
                            ? 'bg-indigo-100 dark:bg-indigo-900/30'
                            : 'bg-blue-100 dark:bg-blue-900/30'
                        } flex items-center justify-center`}>
                          <FolderOpen className={`w-5 h-5 ${
                            selectedBucket === bucket
                              ? 'text-indigo-600 dark:text-indigo-400'
                              : 'text-blue-600 dark:text-blue-400'
                          }`} />
                        </div>
                        <div className="flex-1 min-w-0">
                          <h3 className="text-sm font-semibold text-gray-900 dark:text-white truncate">
                            {bucket}
                          </h3>
                          <p className="text-xs text-gray-500 dark:text-gray-400 mt-0.5">
                            S3 Bucket
                          </p>
                        </div>
                      </div>

                      <div className="flex items-center justify-between text-xs">
                        <span className="text-gray-500 dark:text-gray-400">
                          Click to browse
                        </span>
                        {selectedBucket === bucket && (
                          <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400 font-medium">
                            <CheckCircle className="w-3 h-3" />
                            Active
                          </span>
                        )}
                      </div>
                    </button>
                  ))}
                </div>
              </div>
            )}

            {/* Upload Section */}
            {selectedBucket && (
              <div className="mb-6">
                <div
                  onDragOver={handleDragOver}
                  onDragLeave={handleDragLeave}
                  onDrop={handleDrop}
                  className={`relative bg-white dark:bg-gray-800 rounded-xl border-2 border-dashed transition-all ${
                    dragActive
                      ? 'border-indigo-500 bg-indigo-50 dark:bg-indigo-900/20'
                      : 'border-gray-300 dark:border-gray-600 hover:border-gray-400 dark:hover:border-gray-500'
                  }`}
                >
                  <div className="px-6 py-8 text-center">
                    <div className="flex flex-col items-center">
                      <div className={`w-16 h-16 rounded-2xl flex items-center justify-center mb-4 transition-colors ${
                        dragActive
                          ? 'bg-indigo-100 dark:bg-indigo-900/30'
                          : 'bg-gray-100 dark:bg-gray-700'
                      }`}>
                        <Upload className={`w-8 h-8 ${
                          dragActive ? 'text-indigo-600 dark:text-indigo-400' : 'text-gray-400 dark:text-gray-500'
                        }`} />
                      </div>
                      <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-2">
                        Upload to {selectedBucket}
                      </h3>
                      <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">
                        Drag and drop files here, or click to browse
                      </p>
                      <button
                        onClick={() => fileInputRef.current?.click()}
                        disabled={isUploading}
                        className="inline-flex items-center gap-2 px-6 py-2.5 bg-gradient-to-r from-indigo-600 to-purple-600 text-white text-sm font-medium rounded-lg hover:from-indigo-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all shadow-lg shadow-indigo-500/25 disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        {isUploading ? (
                          <>
                            <Loader2 className="w-5 h-5 animate-spin" />
                            Uploading...
                          </>
                        ) : (
                          <>
                            <Upload className="w-5 h-5" />
                            Select Files
                          </>
                        )}
                      </button>
                      <input
                        ref={fileInputRef}
                        type="file"
                        multiple
                        onChange={handleFileInputChange}
                        className="hidden"
                      />
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Artifacts/Objects Browser */}
            {selectedBucket && (
              <div className="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm overflow-hidden">
                {/* Header */}
                <div className="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center text-white shadow-lg">
                        <File className="w-5 h-5" />
                      </div>
                      <div>
                        <h3 className="text-lg font-semibold text-gray-900 dark:text-white">
                          Objects in {selectedBucket}
                        </h3>
                        <p className="text-sm text-gray-500 dark:text-gray-400 mt-0.5">
                          {artifacts.length} {artifacts.length === 1 ? 'object' : 'objects'}
                          {selectedArtifacts.size > 0 && (
                            <span className="ml-2 text-indigo-600 dark:text-indigo-400 font-medium">
                              • {selectedArtifacts.size} selected
                            </span>
                          )}
                        </p>
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                      {selectedArtifacts.size > 0 && (
                        <button
                          onClick={handleBulkDelete}
                          disabled={isDeletingBulk}
                          className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                          {isDeletingBulk ? (
                            <>
                              <Loader2 className="w-4 h-4 animate-spin" />
                              Deleting...
                            </>
                          ) : (
                            <>
                              <Trash2 className="w-4 h-4" />
                              Delete Selected ({selectedArtifacts.size})
                            </>
                          )}
                        </button>
                      )}
                      <button
                        onClick={() => loadArtifactsForBucket(selectedBucket)}
                        disabled={isLoadingArtifacts}
                        className="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"
                      >
                        <RefreshCw className={`w-4 h-4 ${isLoadingArtifacts ? 'animate-spin' : ''}`} />
                        Refresh
                      </button>
                    </div>
                  </div>
                </div>

                {/* Search Box */}
                {artifacts.length > 0 && (
                  <div className="mb-4">
                    <div className="relative">
                      <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <Search className="h-5 w-5 text-gray-400" />
                      </div>
                      <input
                        type="text"
                        placeholder="Search by filename, type, or status..."
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        className="block w-full pl-10 pr-3 py-2 border border-gray-200 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-gray-900 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 text-sm"
                      />
                      {searchQuery && (
                        <button
                          onClick={() => setSearchQuery('')}
                          className="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
                        >
                          <X className="h-4 w-4" />
                        </button>
                      )}
                    </div>
                    {searchQuery && (
                      <p className="mt-2 text-xs text-gray-500 dark:text-gray-400">
                        Found {filteredAndSortedArtifacts.length} of {artifacts.length} objects
                      </p>
                    )}
                  </div>
                )}

                {/* Content */}
                {isLoadingArtifacts ? (
                  <div className="flex flex-col items-center justify-center py-12">
                    <Loader2 className="h-8 w-8 text-indigo-600 dark:text-indigo-400 animate-spin mb-3" />
                    <p className="text-sm text-gray-500 dark:text-gray-400">Loading objects...</p>
                  </div>
                ) : filteredAndSortedArtifacts.length === 0 ? (
                  <div className="text-center py-12">
                    <div className="mx-auto w-16 h-16 rounded-2xl bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-800 flex items-center justify-center mb-4">
                      <File className="w-8 h-8 text-gray-400 dark:text-gray-500" />
                    </div>
                    <h4 className="text-base font-semibold text-gray-900 dark:text-white mb-2">
                      {searchQuery ? 'No Matching Objects' : 'No Objects Found'}
                    </h4>
                    <p className="text-sm text-gray-500 dark:text-gray-400 max-w-md mx-auto">
                      {searchQuery ? 'Try adjusting your search criteria' : 'This bucket is currently empty'}
                    </p>
                  </div>
                ) : (
                  <div className="overflow-x-auto">
                    <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                      <thead className="bg-gray-50 dark:bg-gray-900/50">
                        <tr>
                          <th scope="col" className="px-6 py-3 text-left">
                            <input
                              type="checkbox"
                              checked={filteredAndSortedArtifacts.length > 0 && selectedArtifacts.size === filteredAndSortedArtifacts.length}
                              onChange={handleSelectAll}
                              className="w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500 cursor-pointer"
                            />
                          </th>
                          <th
                            scope="col"
                            onClick={() => handleSort('filename')}
                            className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
                          >
                            <div className="flex items-center gap-2">
                              <span>Filename</span>
                              {sortColumn === 'filename' ? (
                                sortDirection === 'asc' ? <ArrowUp className="w-4 h-4" /> : <ArrowDown className="w-4 h-4" />
                              ) : (
                                <ArrowUpDown className="w-4 h-4 opacity-30" />
                              )}
                            </div>
                          </th>
                          <th
                            scope="col"
                            onClick={() => handleSort('type')}
                            className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
                          >
                            <div className="flex items-center gap-2">
                              <span>Type</span>
                              {sortColumn === 'type' ? (
                                sortDirection === 'asc' ? <ArrowUp className="w-4 h-4" /> : <ArrowDown className="w-4 h-4" />
                              ) : (
                                <ArrowUpDown className="w-4 h-4 opacity-30" />
                              )}
                            </div>
                          </th>
                          <th
                            scope="col"
                            onClick={() => handleSort('size')}
                            className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
                          >
                            <div className="flex items-center gap-2">
                              <span>Size</span>
                              {sortColumn === 'size' ? (
                                sortDirection === 'asc' ? <ArrowUp className="w-4 h-4" /> : <ArrowDown className="w-4 h-4" />
                              ) : (
                                <ArrowUpDown className="w-4 h-4 opacity-30" />
                              )}
                            </div>
                          </th>
                          <th
                            scope="col"
                            onClick={() => handleSort('status')}
                            className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
                          >
                            <div className="flex items-center gap-2">
                              <span>Status</span>
                              {sortColumn === 'status' ? (
                                sortDirection === 'asc' ? <ArrowUp className="w-4 h-4" /> : <ArrowDown className="w-4 h-4" />
                              ) : (
                                <ArrowUpDown className="w-4 h-4 opacity-30" />
                              )}
                            </div>
                          </th>
                          <th
                            scope="col"
                            onClick={() => handleSort('created')}
                            className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
                          >
                            <div className="flex items-center gap-2">
                              <span>Created</span>
                              {sortColumn === 'created' ? (
                                sortDirection === 'asc' ? <ArrowUp className="w-4 h-4" /> : <ArrowDown className="w-4 h-4" />
                              ) : (
                                <ArrowUpDown className="w-4 h-4 opacity-30" />
                              )}
                            </div>
                          </th>
                          <th scope="col" className="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            Actions
                          </th>
                        </tr>
                      </thead>
                      <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        {filteredAndSortedArtifacts.map((artifact) => (
                          <tr key={artifact.id} className={`hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors ${
                            selectedArtifacts.has(artifact.id) ? 'bg-indigo-50 dark:bg-indigo-900/20' : ''
                          }`}>
                            <td className="px-6 py-4">
                              <input
                                type="checkbox"
                                checked={selectedArtifacts.has(artifact.id)}
                                onChange={() => handleToggleArtifact(artifact.id)}
                                className="w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500 cursor-pointer"
                              />
                            </td>
                            <td className="px-6 py-4">
                              <div className="flex items-center gap-3">
                                <FileText className="w-5 h-5 text-gray-400 dark:text-gray-500 flex-shrink-0" />
                                <div className="min-w-0 flex-1 max-w-xs">
                                  <p
                                    className="text-sm font-medium text-gray-900 dark:text-white truncate cursor-help"
                                    title={artifact.original_filename}
                                  >
                                    {artifact.original_filename}
                                  </p>
                                </div>
                              </div>
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap">
                              <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300">
                                {artifact.artifact_type}
                              </span>
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">
                              {artifact.file_size ? formatBytes(artifact.file_size) : 'Unknown'}
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap">
                              <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                artifact.status === 'available' || artifact.status === 'completed'
                                  ? 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-800 dark:text-emerald-300'
                                  : artifact.status === 'pending'
                                  ? 'bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-300'
                                  : artifact.status === 'failed'
                                  ? 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300'
                                  : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300'
                              }`}>
                                {(artifact.status === 'available' || artifact.status === 'completed') && <CheckCircle className="w-3 h-3 mr-1" />}
                                {artifact.status === 'pending' && <Loader2 className="w-3 h-3 mr-1 animate-spin" />}
                                {artifact.status === 'failed' && <XCircle className="w-3 h-3 mr-1" />}
                                {artifact.status}
                              </span>
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">
                              {formatDate(artifact.created_at)}
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                              <div className="flex items-center justify-end gap-2">
                                <button
                                  onClick={() => handlePreviewArtifact(artifact)}
                                  disabled={artifact.status !== 'available' && artifact.status !== 'completed'}
                                  className="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg transition-colors disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-transparent"
                                  title={artifact.status !== 'available' && artifact.status !== 'completed' ? `File not available (${artifact.status})` : 'Preview'}
                                >
                                  <Eye className="w-4 h-4" />
                                  Preview
                                </button>
                                <button
                                  onClick={() => handleDownloadArtifact(artifact)}
                                  disabled={downloadingId === artifact.id || (artifact.status !== 'available' && artifact.status !== 'completed')}
                                  className="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-indigo-600 dark:text-indigo-400 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 rounded-lg transition-colors disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-transparent"
                                  title={
                                    downloadingId === artifact.id ? 'Downloading...' :
                                    artifact.status !== 'available' && artifact.status !== 'completed' ? `File not available (${artifact.status})` :
                                    'Download'
                                  }
                                >
                                  {downloadingId === artifact.id ? (
                                    <Loader2 className="w-4 h-4 animate-spin" />
                                  ) : (
                                    <Download className="w-4 h-4" />
                                  )}
                                  Download
                                </button>
                                <button
                                  onClick={() => handleDeleteArtifact(artifact)}
                                  className="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
                                  title="Delete"
                                >
                                  <Trash2 className="w-4 h-4" />
                                  Delete
                                </button>
                              </div>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            )}
              </>
            )}
          </>
        )}
      </div>

      {/* Preview Modal */}
      {previewArtifact && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
          <div className="relative bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] flex flex-col overflow-hidden">
            {/* Modal Header */}
            <div className="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-600">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center">
                  <Eye className="w-5 h-5 text-white" />
                </div>
                <div>
                  <h3 className="text-lg font-semibold text-white">
                    {previewArtifact.original_filename}
                  </h3>
                  <p className="text-xs text-indigo-100 mt-0.5">
                    {formatBytes(previewArtifact.file_size || 0)} • {previewArtifact.artifact_type}
                  </p>
                </div>
              </div>
              <button
                onClick={handleClosePreview}
                className="text-white hover:bg-white/20 rounded-lg p-2 transition-colors"
              >
                <X className="w-5 h-5" />
              </button>
            </div>

            {/* Modal Content */}
            <div className="flex-1 overflow-auto p-6">
              {isLoadingPreview ? (
                <div className="flex flex-col items-center justify-center py-12">
                  <Loader2 className="h-12 w-12 text-indigo-600 dark:text-indigo-400 animate-spin mb-4" />
                  <p className="text-sm text-gray-500 dark:text-gray-400">Loading preview...</p>
                </div>
              ) : previewError ? (
                <div className="flex flex-col items-center justify-center py-12">
                  <div className="w-16 h-16 rounded-2xl bg-red-100 dark:bg-red-900/30 flex items-center justify-center mb-4">
                    <AlertCircle className="w-8 h-8 text-red-600 dark:text-red-400" />
                  </div>
                  <p className="text-sm font-medium text-red-800 dark:text-red-200 mb-2">Preview Failed</p>
                  <p className="text-sm text-gray-600 dark:text-gray-400">{previewError}</p>
                </div>
              ) : previewBlob ? (
                <FilePreview
                  blob={previewBlob}
                  filename={previewArtifact.original_filename}
                  contentType={previewArtifact.content_type}
                />
              ) : null}
            </div>

            {/* Modal Footer */}
            <div className="flex items-center justify-between px-6 py-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
              <div className="text-xs text-gray-500 dark:text-gray-400">
                Created: {formatDate(previewArtifact.created_at)}
              </div>
              <div className="flex gap-2">
                <button
                  onClick={() => {
                    handleDownloadArtifact(previewArtifact)
                  }}
                  className="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg transition-colors"
                >
                  <Download className="w-4 h-4" />
                  Download
                </button>
                <button
                  onClick={handleClosePreview}
                  className="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg transition-colors"
                >
                  Close
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Upload Modal */}
      {showUploadModal && uploadTargetBucket && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
          <div className="relative bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden">
            {/* Modal Header */}
            <div className="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gradient-to-r from-emerald-600 via-teal-600 to-emerald-600">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center">
                  <Upload className="w-5 h-5 text-white" />
                </div>
                <div>
                  <h3 className="text-lg font-semibold text-white">Upload Files</h3>
                  <p className="text-xs text-emerald-100 mt-0.5">
                    {uploadTargetBucket} / {uploadTargetPrefix || '(root)'}
                  </p>
                </div>
              </div>
              <button
                onClick={() => setShowUploadModal(false)}
                disabled={isUploading}
                className="text-white hover:bg-white/20 rounded-lg p-2 transition-colors disabled:opacity-50"
              >
                <X className="w-5 h-5" />
              </button>
            </div>

            {/* Modal Content */}
            <div className="p-6">
              <div
                onDragOver={handleDragOver}
                onDragLeave={handleDragLeave}
                onDrop={handleDrop}
                className={`relative bg-white dark:bg-gray-900 rounded-xl border-2 border-dashed transition-all ${
                  dragActive
                    ? 'border-emerald-500 bg-emerald-50 dark:bg-emerald-900/20'
                    : 'border-gray-300 dark:border-gray-600 hover:border-gray-400 dark:hover:border-gray-500'
                }`}
              >
                <div className="px-6 py-10 text-center">
                  <div className="flex flex-col items-center">
                    <div className={`w-16 h-16 rounded-2xl flex items-center justify-center mb-4 transition-colors ${
                      dragActive
                        ? 'bg-emerald-100 dark:bg-emerald-900/30'
                        : 'bg-gray-100 dark:bg-gray-700'
                    }`}>
                      <Upload className={`w-8 h-8 ${
                        dragActive ? 'text-emerald-600 dark:text-emerald-400' : 'text-gray-400 dark:text-gray-500'
                      }`} />
                    </div>
                    <h4 className="text-base font-semibold text-gray-900 dark:text-white mb-2">
                      Drop files here
                    </h4>
                    <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">
                      or click to browse
                    </p>
                    <button
                      onClick={() => fileInputRef.current?.click()}
                      disabled={isUploading}
                      className="inline-flex items-center gap-2 px-5 py-2.5 bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-medium rounded-lg transition-colors shadow-lg shadow-emerald-500/25 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      {isUploading ? (
                        <>
                          <Loader2 className="w-5 h-5 animate-spin" />
                          Uploading...
                        </>
                      ) : (
                        <>
                          <Upload className="w-5 h-5" />
                          Select Files
                        </>
                      )}
                    </button>
                    <input
                      ref={fileInputRef}
                      type="file"
                      multiple
                      onChange={handleFileInputChange}
                      className="hidden"
                    />
                  </div>
                </div>
              </div>

              {uploadTargetPrefix && (
                <div className="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                  <p className="text-xs text-blue-800 dark:text-blue-200">
                    <strong>Note:</strong> Files will be uploaded to: <span className="font-mono">{uploadTargetBucket}/{uploadTargetPrefix}</span>
                  </p>
                </div>
              )}
            </div>

            {/* Modal Footer */}
            <div className="flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
              <button
                onClick={() => setShowUploadModal(false)}
                disabled={isUploading}
                className="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg transition-colors disabled:opacity-50"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}
